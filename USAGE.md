# 膝蓋抬腿分析系統 - 無線資料採集使用說明

## 📋 系統概述

這是一個使用 ESP32-C3 + ICM-20948 IMU 感測器的膝蓋抬腿動作分析系統，透過 Wi-Fi + MQTT 進行無線資料傳輸。

**系統架構**：
```
ESP32-C3 (綁在大腿)
    ↓ Wi-Fi
手機熱點 (Bt)
    ↓ 4G/5G
MQTT Broker (mqtt.singularinnovation-ai.com)
    ↓ 網際網路
電腦 (執行 Python 接收腳本)
```

---

## 🔧 硬體需求

1. **ESP32-C3 Super Mini** + **GY-ICM20948 IMU 感測器**
2. **行動電源** (供電給 ESP32)
3. **手機** (開啟熱點，帶在身上)
4. **電腦** (執行 Python 接收腳本)

**接線方式**：
- VCC → 3.3V
- GND → GND
- SDA → GPIO5
- SCL → GPIO6

---

## 📱 使用步驟

### **步驟 1：手機設定熱點**

#### Android:
1. 設定 → 網路與網際網路 → 無線基地台與網路共用
2. 開啟「可攜式無線基地台」
3. 設定：
   - **網路名稱 (SSID)**: `Bt`
   - **密碼**: `bt_980904`

#### iOS:
1. 設定 → 個人熱點
2. 開啟「允許其他人加入」
3. Wi-Fi 密碼設為：`bt_980904`
4. 重新命名為：`Bt`（設定 → 一般 → 關於本機 → 名稱）

---

### **步驟 2：上傳程式到 ESP32**

1. 用 USB 連接 ESP32 到電腦
2. 在 VS Code 中開啟專案
3. 點擊 PlatformIO 的 **Upload** 按鈕
4. 等待上傳完成

**如果上傳失敗**：
- 按住 **BOOT** 按鈕
- 按下 **RESET** 按鈕
- 釋放兩個按鈕，重新上傳

---

### **步驟 3：測試連線（選用）**

1. 點擊 PlatformIO 的 **Monitor** 按鈕
2. 觀察序列埠輸出，應該會看到：
   ```
   ✓ Wi-Fi 連線成功！
   IP 位址: 192.168.x.x
   ✓ MQTT 連線成功！
   ```
3. 確認連線正常後，可以關閉 Monitor

---

### **步驟 4：在電腦執行接收腳本**

#### 安裝 Python 套件（首次使用）：
```bash
pip install paho-mqtt
```

#### 執行接收腳本：
```bash
python mqtt_receiver.py
```

**預期輸出**：
```
============================================================
膝蓋抬腿分析系統 - MQTT 資料接收器
============================================================
CSV 檔案: knee_data_20241108_143025.csv
按 Ctrl+C 停止記錄
============================================================

正在連接到 mqtt.singularinnovation-ai.com:1883...
✓ 成功連接到 MQTT Broker
  伺服器: mqtt.singularinnovation-ai.com:1883
  訂閱主題: knee-drive/data

等待 ESP32 資料...
============================================================
[  10] 角度:  12.5° | ΔY:   5.2 | ΔZ:   8.3 | 穩定: 是 | 已接收 1.0s
[  20] 角度:  15.3° | ΔY:   7.8 | ΔZ:  10.1 | 穩定: 是 | 已接收 2.0s
```

---

### **步驟 5：開始跑步測試**

1. **準備階段**：
   - ESP32 綁在大腿上（固定好，避免晃動）
   - 行動電源供電
   - 手機放在口袋或臂套（距離 ESP32 5-10 公尺內）
   - 電腦執行 `mqtt_receiver.py`

2. **校正階段**：
   - ESP32 開機後，**保持站立姿勢不動 3 秒**
   - 等待自動校正完成

3. **測試階段**：
   - 開始跑步或原地抬腿
   - 電腦會即時顯示資料並自動儲存 CSV

4. **結束記錄**：
   - 在電腦上按 **Ctrl+C** 停止記錄
   - CSV 檔案會自動儲存

---

## 📊 資料格式

### **CSV 檔案欄位**

| 欄位 | 說明 | 單位 |
|------|------|------|
| 時間戳記 | 資料接收時間 | - |
| 運行時間(s) | ESP32 運行時間 | 秒 |
| 角度(deg) | 大腿抬起角度 | 度 |
| ΔX(cm) | 相對左右位移 | 公分 |
| ΔY(cm) | 相對前後位移 | 公分 |
| ΔZ(cm) | 相對上下位移 | 公分 |
| 絕對X(cm) | 膝蓋絕對 X 座標 | 公分 |
| 絕對Y(cm) | 膝蓋絕對 Y 座標 | 公分 |
| 絕對Z(cm) | 膝蓋絕對 Z 座標 | 公分 |
| 是否穩定 | 數值穩定度 | 是/否 |
| 加速度X/Y/Z | 三軸加速度 | g |
| 陀螺儀X/Y/Z | 三軸角速度 | deg/s |

### **JSON 資料格式（MQTT）**

```json
{
  "timestamp": 3.45,
  "elapsed_time": 3.45,
  "angle": 12.5,
  "stable": true,
  "delta": {
    "x": 0.0,
    "y": 5.2,
    "z": 8.3
  },
  "absolute": {
    "x": 0.0,
    "y": 5.2,
    "z": -43.7
  },
  "accel": {
    "x": 0.123,
    "y": 0.045,
    "z": 0.987
  },
  "gyro": {
    "x": 2.5,
    "y": -1.3,
    "z": 0.8
  }
}
```

---

## ⚙️ 進階設定

### **修改 Wi-Fi 設定**

編輯 `src/main.cpp` 第 9-10 行：
```cpp
const char* WIFI_SSID = "你的WiFi名稱";
const char* WIFI_PASSWORD = "你的WiFi密碼";
```

### **修改 MQTT Topic**

編輯 `src/main.cpp` 第 17 行：
```cpp
const char* MQTT_TOPIC = "knee-drive/data";  // 改成你的 Topic
```

同時修改 `mqtt_receiver.py` 第 18 行：
```python
MQTT_TOPIC = "knee-drive/data"  # 改成相同的 Topic
```

### **修改取樣頻率**

目前取樣頻率約 **100 Hz**（每秒 100 筆資料），如需調整：

在 `src/main.cpp` 的 `loop()` 最後加入延遲：
```cpp
delay(10);  // 延遲 10ms，降低至約 100 Hz
```

---

## 🔍 故障排除

### **問題 1：ESP32 無法連接 Wi-Fi**

**檢查項目**：
- 手機熱點是否已開啟
- SSID 和密碼是否正確（區分大小寫）
- ESP32 是否在手機附近（5-10 公尺內）

**解決方法**：
- 重新檢查 `main.cpp` 中的 Wi-Fi 設定
- 重新上傳程式到 ESP32
- 重啟手機熱點

---

### **問題 2：Python 腳本無法連接 MQTT**

**檢查項目**：
- 電腦是否有網路連線
- MQTT 伺服器是否正常運作

**解決方法**：
```bash
# 測試 MQTT 伺服器連線
ping mqtt.singularinnovation-ai.com
```

---

### **問題 3：收不到資料**

**檢查項目**：
- ESP32 序列埠是否顯示「✓ 資料已發送到 MQTT」
- Python 腳本是否顯示「等待 ESP32 資料...」
- Topic 名稱是否一致

**解決方法**：
- 確認 ESP32 和 Python 使用相同的 Topic
- 重啟 ESP32 和 Python 腳本

---

### **問題 4：資料傳輸延遲**

**可能原因**：
- 手機訊號不佳
- MQTT 伺服器負載過高

**解決方法**：
- 確保手機有良好的 4G/5G 訊號
- 縮短 ESP32 與手機的距離
- 考慮使用本地 MQTT Broker（進階）

---

## 📈 資料分析範例

### **使用 Python 分析**

```python
import pandas as pd
import matplotlib.pyplot as plt

# 讀取 CSV
df = pd.read_csv('knee_data_20241108_143025.csv')

# 繪製角度變化圖
plt.figure(figsize=(12, 6))
plt.plot(df['運行時間(s)'], df['角度(deg)'])
plt.xlabel('時間 (秒)')
plt.ylabel('大腿角度 (度)')
plt.title('跑步時膝蓋抬腿角度變化')
plt.grid(True)
plt.show()

# 計算統計數據
print(f"平均抬腿角度: {df['角度(deg)'].mean():.1f}°")
print(f"最大抬腿角度: {df['角度(deg)'].max():.1f}°")
print(f"最大抬腿高度: {df['ΔZ(cm)'].max():.1f} cm")
```

### **使用 Excel 分析**

1. 開啟 CSV 檔案
2. 選取資料範圍
3. 插入 → 圖表 → 折線圖
4. 分析趨勢與統計數據

---

## 🎯 使用場景

### **場景 1：跑步機測試**
- 電腦放在跑步機旁
- 即時監控抬腿動作
- 適合短距離測試

### **場景 2：操場跑步**
- 手機放在口袋/臂套
- ESP32 綁在大腿
- 可自由移動 200 公尺

### **場景 3：室內訓練**
- 連接家中 Wi-Fi
- 長時間資料記錄
- 適合詳細分析

---

## 📞 技術支援

如有問題，請檢查：
1. ESP32 序列埠輸出（USB Monitor）
2. Python 腳本輸出訊息
3. Wi-Fi 和 MQTT 連線狀態

---

## 📝 版本資訊

- **版本**: 1.0.0
- **更新日期**: 2024-11-08
- **相容硬體**: ESP32-C3 Super Mini + ICM-20948
- **通訊協定**: Wi-Fi + MQTT
- **資料格式**: JSON → CSV

---

**祝你測試順利！🏃‍♂️💨**
